import sys  
from PyQt5 import QtCore, QtGui, QtWidgets  
from PyQt5.QtWidgets import QLabel, QFileDialog, QMainWindow, QApplication, QPushButton, QWidget, QTableWidgetItem  
from PyQt5.QtGui import QPixmap  
from PyQt5.QtMultimedia import QMediaPlayer, QMediaContent  
from PyQt5.QtMultimediaWidgets import QVideoWidget  
import cv2  
import numpy as np  
from ultralytics import YOLO  
import io  
from contextlib import redirect_stdout  
  
class Ui_MainWindow(object):  
    def setupUi(self, MainWindow):  
        MainWindow.setObjectName("yolov8")  
        MainWindow.setEnabled(True)  
        MainWindow.setFixedSize(800, 600)  
  
        self.centralwidget = QtWidgets.QWidget(MainWindow)  
        self.centralwidget.setObjectName("centralwidget")  
  
        # 初始化媒体播放器和视频控件  
        self.media_player = QMediaPlayer(None, QMediaPlayer.VideoSurface)  
        self.video_widget = QVideoWidget(self.centralwidget)  
        self.video_widget.setGeometry(QtCore.QRect(170, 20, 421, 291))  
  
        # 创建媒体标签用于显示图片  
        self.media_label = QLabel(self.centralwidget)  
        self.media_label.setGeometry(QtCore.QRect(170, 20, 421, 291))  
        self.media_label.setScaledContents(True)  
  
        # 创建垂直和水平滑动条  
        self.slider_vertical = QtWidgets.QSlider(self.centralwidget)  
        self.slider_vertical.setGeometry(QtCore.QRect(600, 20, 20, 291))  
        self.slider_vertical.setOrientation(QtCore.Qt.Vertical)  
  
        self.slider_horizontal = QtWidgets.QSlider(self.centralwidget)  
        self.slider_horizontal.setGeometry(QtCore.QRect(170, 320, 421, 20))  
        self.slider_horizontal.setOrientation(QtCore.Qt.Horizontal)  
  
        # 创建其他控件  
        self.fontComboBox = QtWidgets.QFontComboBox(self.centralwidget)  
        self.fontComboBox.setGeometry(QtCore.QRect(20, 20, 121, 22))  
  
        self.add_video = QPushButton("Add Media", self.centralwidget)  
        self.add_video.setGeometry(QtCore.QRect(20, 50, 121, 71))  
  
        self.video_bigger = QPushButton("+", self.centralwidget)  
        self.video_bigger.setGeometry(QtCore.QRect(20, 130, 51, 51))  
  
        self.video_smaller = QPushButton("-", self.centralwidget)  
        self.video_smaller.setGeometry(QtCore.QRect(90, 130, 51, 51))  
  
        self.mod_change_button = QtWidgets.QComboBox(self.centralwidget)  
        self.mod_change_button.setGeometry(QtCore.QRect(20, 190, 121, 31))  
        self.mod_change_button.addItems(["普通模型", "train_best模型", "train5_best模型"])  
  
        self.detect_button = QPushButton('Detect', self.centralwidget)  
        self.detect_button.setGeometry(QtCore.QRect(20, 230, 121, 31))  
  
        # 创建表格控件  
        self.tableWidget = QtWidgets.QTableWidget(self.centralwidget)  
        self.tableWidget.setGeometry(QtCore.QRect(170, 350, 621, 200))  
        self.tableWidget.setColumnCount(7)  # 增加列数  
        self.tableWidget.setRowCount(0)  # 初始行数为0  
        self.tableWidget.setHorizontalHeaderLabels(['Type', 'Object', 'Confidence', 'X', 'Y', 'Width', 'Height'])  
  
        MainWindow.setCentralWidget(self.centralwidget)  
        self.statusbar = QtWidgets.QStatusBar(MainWindow)  
        MainWindow.setStatusBar(self.statusbar)  
  
        self.retranslateUi(MainWindow)  
        QtCore.QMetaObject.connectSlotsByName(MainWindow)  
  
        # 连接信号和槽  
        self.add_video.clicked.connect(self.open_media)  
        self.video_bigger.clicked.connect(self.zoom_in)  
        self.video_smaller.clicked.connect(self.zoom_out)  
        self.detect_button.clicked.connect(self.detect_image)  
        self.fontComboBox.currentFontChanged.connect(self.change_font)  
        self.slider_vertical.valueChanged.connect(self.adjust_vertical)  
        self.slider_horizontal.valueChanged.connect(self.adjust_horizontal)  
        self.mod_change_button.currentIndexChanged.connect(self.change_model)   # 切换模型按钮  
  
        # 初始化YOLOv8模型  
        self.yolo_model = YOLO("yolov8n.pt")  
        self.duo_model = YOLO(r"E:\wdc\yolov8\runs\DUO\train\weights\best.pt")  
        self.duo2_model = YOLO(r"E:\wdc\yolov8\runs\DUO\train5\weights\best.pt")  
        self.current_model = self.yolo_model  
  
    def retranslateUi(self, MainWindow):  
        _translate = QtCore.QCoreApplication.translate  
        MainWindow.setWindowTitle(_translate("MainWindow", "YOLOv8 Detector"))  
  
    def open_media(self):  
        options = QFileDialog.Options()  
        file_path, _ = QFileDialog.getOpenFileName(None, "Open Media File", "", "Media Files (*.mp4 *.avi *.jpg *.png);;All Files (*)", options=options)  
        if file_path:  
            if file_path.endswith(('.jpg', '.png')):  
                self.load_image(file_path)  
            else:  
                self.play_video(file_path)  
  
    def change_model(self, index):  
        if index == 0:  
            self.current_model = self.yolo_model  
        elif index == 1:  
            self.current_model = self.duo_model  
        elif index == 2:  
            self.current_model = self.duo2_model  
        print(f"Changed to model: {self.mod_change_button.currentText()}")  
  
  
    def load_image(self, file_path):  
        pixmap = QPixmap(file_path)  
        self.media_label.setPixmap(pixmap)  
        self.media_player.stop()  
        self.media_label.show()  
        self.video_widget.hide()  
  
    def play_video(self, file_path):  
        self.media_player.setMedia(QMediaContent(QtCore.QUrl.fromLocalFile(file_path)))  
        self.media_player.play()  
        self.media_label.hide()  
        self.video_widget.show()  
  
    def zoom_in(self):  
        current_size = self.media_label.size()  
        new_size = current_size * 1.2  
        self.media_label.resize(new_size)  
  
    def zoom_out(self):  
        current_size = self.media_label.size()  
        new_size = current_size * 0.8  
        self.media_label.resize(new_size)  
  
    def detect_image(self):  
        current_pixmap = self.media_label.pixmap()  
        if current_pixmap:  
            # 将QPixmap转换为QImage  
            qimage = current_pixmap.toImage()  
            # 将QImage转换为numpy数组  
            width, height = qimage.width(), qimage.height()  
            ptr = qimage.constBits()  
            ptr.setsize(height * width * 4)  
            arr = np.frombuffer(ptr, np.uint8).reshape((height, width, 4))  
            image = cv2.cvtColor(arr, cv2.COLOR_RGBA2BGR)  
  
            # 捕获当前模型的输出  
            f = io.StringIO()  
            with redirect_stdout(f):  
                results = self.current_model(image)  # 使用当前选择的模型  
            output = f.getvalue()  
  
            # 清空表格  
            self.tableWidget.setRowCount(0)  
  
            # 添加模型的输出到表格  
            for line in output.strip().split('\n'):  
                row_position = self.tableWidget.rowCount()  
                self.tableWidget.insertRow(row_position)  
                self.tableWidget.setItem(row_position, 0, QTableWidgetItem("Info"))  
                self.tableWidget.setItem(row_position, 1, QTableWidgetItem(line))  
  
            # 在图像上绘制检测结果并更新表格  
            for result in results:  
                for box in result.boxes:  
                    x1, y1, x2, y2 = box.xyxy[0]  
                    label = result.names[int(box.cls)]  
                    confidence = float(box.conf)  
  
                    cv2.rectangle(image, (int(x1), int(y1)), (int(x2), int(y2)), (0, 255, 0), 2)  
                    cv2.putText(image, f"{label} {confidence:.2f}", (int(x1), int(y1) - 10), cv2.FONT_HERSHEY_SIMPLEX, 0.9, (0, 255, 0), 2)  
  
                    row_position = self.tableWidget.rowCount()  
                    self.tableWidget.insertRow(row_position)  
                    self.tableWidget.setItem(row_position, 0, QTableWidgetItem("Detection"))  
                    self.tableWidget.setItem(row_position, 1, QTableWidgetItem(label))  
                    self.tableWidget.setItem(row_position, 2, QTableWidgetItem(f"{confidence:.2f}"))  
                    self.tableWidget.setItem(row_position, 3, QTableWidgetItem(f"{int(x1)}"))  
                    self.tableWidget.setItem(row_position, 4, QTableWidgetItem(f"{int(y1)}"))  
                    self.tableWidget.setItem(row_position, 5, QTableWidgetItem(f"{int(x2-x1)}"))  
                    self.tableWidget.setItem(row_position, 6, QTableWidgetItem(f"{int(y2-y1)}"))  
  
            # 将处理后的图像显示在界面上  
            image_rgb = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)  
            h, w, ch = image_rgb.shape  
            bytes_per_line = ch * w  
            q_image = QtGui.QImage(image_rgb.data, w, h, bytes_per_line, QtGui.QImage.Format_RGB888)  
            pixmap = QtGui.QPixmap.fromImage(q_image)  
            self.media_label.setPixmap(pixmap)  
            self.media_label.show()  
            self.video_widget.hide()  
        else:  
            print("No image loaded")  
  
    def change_font(self, font):  
        # 更改所有按钮的字体  
        for button in self.centralwidget.findChildren(QPushButton):  
            button.setFont(font)  
  
    def adjust_vertical(self, value):  
        # 调整图片垂直位置  
        current_geometry = self.media_label.geometry()  
        new_y = 20 + (291 - self.media_label.height()) * value / 100  
        self.media_label.setGeometry(current_geometry.x(), int(new_y), current_geometry.width(), current_geometry.height())  
  
    def adjust_horizontal(self, value):  
        # 调整图片水平位置  
        current_geometry = self.media_label.geometry()  
        new_x = 170 + (421 - self.media_label.width()) * value / 100  
        self.media_label.setGeometry(int(new_x), current_geometry.y(), current_geometry.width(), current_geometry.height())  
  
if __name__ == "__main__":  
    app = QApplication(sys.argv)  
    MainWindow = QMainWindow()  
    ui = Ui_MainWindow()  
    ui.setupUi(MainWindow)  
    MainWindow.show()  
    sys.exit(app.exec_())
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTE5NTcwNjkxMTNdfQ==
-->